<label @FLUENT_LOG>
  <match fluent.**>
    @type null
    @id ignore_fluent_logs
  </match>
</label>

<source>
  @type tail
  @id in_tail_container_logs
  path "/var/log/containers/*.log"
  pos_file "/var/log/fluentd-containers.log.pos"
  tag "kubernetes.*"
  exclude_path /var/log/containers/fluent*
  read_from_head true
  <parse>
    @type regexp
    expression /^(?<time>.+) (?<stream>stdout|stderr)( (?<logtag>.))? (?<log>.*)$/
    time_format "%Y-%m-%dT%H:%M:%S.%NZ"
    ignorecase false
    multiline false
    unmatched_lines warn  # Log warnings for unmatched lines to troubleshoot parsing
  </parse>
</source>

<match **>
  @type elasticsearch
  @id out_es
  @log_level "info"  # Change to "debug" temporarily if you need detailed error logs
  include_tag_key true
  host "elasticsearch.elastic-stack.svc.cluster.local"
  port 9200
  path ""
  scheme http
  ssl_verify false
  ssl_version TLSv1_2
  user ""
  password "xxxxxx"  # Ensure this is correctly set if Elasticsearch has authentication
  reload_connections false
  reconnect_on_error true
  reload_on_failure true
  log_es_400_reason false
  logstash_prefix "fluentd"  # Customize if desired
  logstash_dateformat "%Y.%m.%d"
  logstash_format true
  index_name "logstash"  # Optional; rely on logstash_format and prefix if this is unwanted
  type_name "fluentd"
  include_timestamp false
  suppress_type_name true
  enable_ilm false
  ilm_policy_id logstash-policy
  <buffer>
    flush_thread_count 8
    flush_interval 5s
    chunk_limit_size 2M
    queue_limit_length 32
    retry_max_interval 30
    retry_forever true
  </buffer>
</match>
